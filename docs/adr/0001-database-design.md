# ADR 0001: Database Design and Decisions

## Status
Accepted

## Context
This ADR documents the design and decisions for the database schema and ORM mapping for the banking application. The implementation uses PostgreSQL as the database and GORM as the ORM in Go. The schema is designed to support basic banking operations: account management, money transfers, entry logging, and user management (authentication and account ownership).

**Update:** The application now uses UUIDs as primary keys for all tables except for the `users` table, which uses a UUID primary key and a unique username. This improves uniqueness across distributed systems and future-proofs the schema for scalability and sharding.

## Decision
### Tables and Models

#### 1. Users
- **Table:** `users`
- **Model:** `User`
- **Fields:**
  - `id` (uuid, PK, default generated by `uuid_generate_v4()`)
  - `username` (varchar(255), unique, not null)
  - `password` (varchar(255), not null)
  - `email` (varchar(255), unique, not null)
  - `full_name` (varchar(255), not null)
  - `password_changed_at` (timestamp, not null, default '0001-01-01 00:00:00Z')
  - `created_at` (timestamp, not null, default now())
- **Associations:**
  - Has many `accounts` (with cascade on update/delete)

#### 2. Accounts
- **Table:** `accounts`
- **Model:** `Account`
- **Fields:**
  - `id` (uuid, PK, default generated by `uuid_generate_v4()`)
  - `owner` (varchar, indexed, not null, FK to users.username)
  - `balance` (bigint, not null)
  - `currency` (varchar, not null)
  - `created_at` (timestamptz, not null, default now())
- **Associations:**
  - Belongs to `User` (via `owner`)
  - Has many `entries` (with cascade on update/delete)
  - Has many `transfers` as both sender (`TransfersFrom`) and receiver (`TransfersTo`)
- **Constraints:**
  - Composite unique key on (`owner`, `currency`) to prevent duplicate currencies for the same user

#### 3. Entries
- **Table:** `entries`
- **Model:** `Entry`
- **Fields:**
  - `id` (uuid, PK, default generated by `uuid_generate_v4()`)
  - `account_id` (uuid, FK to accounts, indexed, not null)
  - `amount` (bigint, not null, can be negative or positive)
  - `created_at` (timestamptz, not null, default now())
- **Associations:**
  - Belongs to `Account`
- **Notes:**
  - The `amount` field can be negative or positive to represent debits and credits.

#### 4. Transfers
- **Table:** `transfers`
- **Model:** `Transfer`
- **Fields:**
  - `id` (uuid, PK, default generated by `uuid_generate_v4()`)
  - `from_account_id` (uuid, FK to accounts, indexed, not null)
  - `to_account_id` (uuid, FK to accounts, indexed, not null)
  - `amount` (bigint, not null, must be positive)
  - `created_at` (timestamptz, not null, default now())
- **Associations:**
  - Belongs to `Account` as both sender (`FromAccount`) and receiver (`ToAccount`)
- **Notes:**
  - The `amount` field must always be positive.

### Indexes
- Indexes are created on `accounts.owner`, `entries.account_id`, `transfers.from_account_id`, `transfers.to_account_id`, and the composite (`from_account_id`, `to_account_id`).

### Foreign Keys and Constraints
- All foreign keys are UUIDs and set to `ON UPDATE CASCADE, ON DELETE CASCADE` to maintain referential integrity and simplify cleanup.

### ORM Mapping
- GORM struct tags are used to enforce constraints, indexes, and relationships.
- Table names are explicitly set in each model to match the database schema.
- UUIDs are generated by the database using the `uuid_generate_v4()` function.

### Migration
- Migration logic is stubbed in `db/migrations.go` and should be extended to auto-migrate models and manage schema changes.
- The `AddUUIDExtension` function is included to ensure the `uuid-ossp` extension is available for UUID generation.

## Consequences
- The schema is normalized and supports efficient queries for account, entry, and transfer operations.
- Cascading deletes and updates ensure data integrity but require careful handling in business logic to avoid accidental data loss.
- The use of UUIDs as primary keys improves uniqueness and scalability, especially in distributed environments.
- The design is extensible for future features (e.g., transaction types, audit logs).


## References
- [GORM Documentation](https://gorm.io/docs/)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/) 