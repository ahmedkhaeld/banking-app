# ADR 0003: Account Module Design and Database Decisions

## Status
Accepted

## Context
This ADR documents the design and implementation decisions for the Account module in the banking application. The Account module is responsible for managing user bank accounts, including creation, retrieval, and association with users, entries, and transfers. The implementation uses Go (Gin, GORM) and PostgreSQL, following the overall architecture described in [ADR 0001](0001-database-design.md).

## Decision

### Go Model (`models.Account`)
The `Account` struct is defined in `db/models/account.go`:

```go
// db/models/account.go
import (
    "time"
    "github.com/google/uuid"
)

type Account struct {
    ID        uuid.UUID `json:"id" gorm:"type:uuid;primaryKey;default:uuid_generate_v4()"`
    UserID    uuid.UUID `json:"user_id" gorm:"type:uuid;not null;index"`
    Balance   int64     `json:"balance" gorm:"type:bigint;default:0"`
    Owner     string    `json:"owner" gorm:"index;not null"`
    Currency  string    `json:"currency" gorm:"not null"`
    CreatedAt time.Time `json:"created_at" gorm:"not null;autoCreateTime"`
    UpdatedAt time.Time `json:"updated_at" gorm:"not null;autoUpdateTime"`
    // Relationships
    Entries       []Entry    `json:"entries" gorm:"foreignKey:AccountID;constraint:OnUpdate:CASCADE,OnDelete:CASCADE"`
    TransfersFrom []Transfer `json:"transfers_from" gorm:"foreignKey:FromAccountID;constraint:OnUpdate:CASCADE,OnDelete:CASCADE"`
    TransfersTo   []Transfer `json:"transfers_to" gorm:"foreignKey:ToAccountID;constraint:OnUpdate:CASCADE,OnDelete:CASCADE"`
}
```

#### Key Fields and Constraints
- **ID**: UUID primary key, generated by the database (`uuid_generate_v4()`).
- **UserID**: UUID foreign key referencing the owning user.
- **Owner**: Username of the account owner (indexed, not null).
- **Balance**: Account balance (bigint, default 0).
- **Currency**: Account currency (not null, validated on creation).
- **Timestamps**: `CreatedAt` and `UpdatedAt` managed by GORM.
- **Relationships**: Has many `Entries` and `Transfers` (both as sender and receiver), with cascading updates and deletes.

#### Table Name
The table name is explicitly set to `accounts` via the `TableName()` method.

### Database Schema
- **Table**: `accounts`
- **Primary Key**: `id` (UUID)
- **Foreign Keys**: `user_id` (references `users.id`), with `ON UPDATE CASCADE, ON DELETE CASCADE`.
- **Indexes**: On `user_id` and `owner` for efficient lookups.
- **Associations**: Accounts are linked to users, entries, and transfers, supporting cascading operations for data integrity.

### API and Service Layer
- The Account module exposes RESTful endpoints for account creation, retrieval, update, and deletion, protected by JWT authentication (see [ADR 0002](0002-user-authentication.md)).
- The controller (`internal/account/controller.go`) handles HTTP requests and responses, using Gin for routing and validation.

### Rationale
- **UUIDs** are used for primary and foreign keys to ensure uniqueness and scalability.
- **Cascading** relationships simplify cleanup and maintain referential integrity.
- **Explicit GORM tags** ensure the Go model matches the database schema.
- **Separation of concerns**: The module is split into model, repository, service, and controller layers for maintainability and testability.

## Consequences
- The Account module is robust, scalable, and enforces data integrity.
- The design supports future extensibility (e.g., multi-currency, account types).
- The use of UUIDs and cascading constraints aligns with the overall database strategy.

## References
- [ADR 0001: Database Design and Decisions](0001-database-design.md)
- [ADR 0002: User Authentication and Login Implementation](0002-user-authentication.md)
- [GORM Documentation](https://gorm.io/docs/)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/) 